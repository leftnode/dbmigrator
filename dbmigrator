#!/usr/bin/env php
<?php

declare(encoding='UTF-8');
require_once('dbmigrator/dbmigrator.class.php');

$cwd = getcwd();
$local_config = implode(DIRECTORY_SEPARATOR, array($cwd, 'build', 'dbmigrator.config.php'));

if (is_file($local_config)) {
	require_once($local_config);
} else {
	require_once('dbmigrator/dbmigrator.config.php');
}

$dbmigrator = new dbmigrator(DB_TYPE);
$dbmigrator->set_migration_path(MIGRATION_PATH);

if (1 == $argc) {
	echo("Please enter at least one argument.");
	exit(1);
}

try {
	$db_type = strtolower(DB_TYPE);

	$pdo = new PDO($db_type.':host='.DB_HOST.';dbname='.DB_NAME, DB_USER, DB_PASSWORD);
	if ('mysql' === $db_type) {
		$pdo->setAttribute(PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, 1);
	}

	$dbmigrator->attach_pdo($pdo);
} catch (PDOException $e) {
	echo("Failed to connect to the database with specified credentials. Actions 'rollback' and 'update' are unavailable, 'create' is available.");
	exit(1);
}

$action = strtolower($argv[1]);
switch ($action) {
	case 'create': {
		if ($argc < 2) {
			echo("Enter the name of at least one script to create.");
			exit(1);
		} else {
			$scripts = array_slice($argv, 2);
			$scripts_count = count($scripts);

			for ($i=0; $i<$scripts_count; $i++) {
				$script_name = $dbmigrator->create($scripts[$i]);
				echo("Successfully created ".$script_name.PHP_EOL);
				sleep(2);
			}
		}
		break;
	}

	case 'snapshot': {
		if ($argc != 3) {
			$dbmigrator->error("Specify a snapshot name.");
		} else {
			$snapshot = $argv[2];
			$dbmigrator->createSnapshot($snapshot);
		}
	}

	case 'update': {
		$utc_timestamp = -1;
		if (3 == $argc) {
			$utc_timestamp = trim($argv[2]);
		}

		$dbmigrator->update($utc_timestamp);
		break;
	}

	case 'rollback': {
		$utc_timestamp = 0;
		if (3 == $argc) {
			$utc_timestamp = trim($argv[2]);
		}

		$dbmigrator->rollback($utc_timestamp);
		break;
	}

	case 'default': {
		echo("Usage: dbmigrator [create,snapshot,update,rollback] [<script-name>,<snapshot-name>,[<timestamp>,<snapshot>],[<timestamp>,<snapshot>]]");
		exit(1);
		break;
	}
}

exit(0);