#!/usr/bin/env php
<?php

declare(encoding='UTF-8');
require_once(__DIR__.'/dbmigrator.class.php');

$cwd = getcwd();
$project_config = implode(DIRECTORY_SEPARATOR, array($cwd, 'build', 'dbmigrator.config.php'));
$local_config = __DIR__.'/dbmigrator.config.php';

$configuration_file = $project_config;
if (!is_file($project_config)) {
	$configuration_file = null;
	
	if (is_file($local_config)) {
		$configuration_file = $local_config;
	}
}

if (empty($configuration_file)) {
	echo("A valid dbmigrator.config.php could not be found in the project path or the local path. Giving up.".PHP_EOL.PHP_EOL);
	exit(1);
}

require_once($configuration_file);

$dbmigrator = new dbmigrator(DB_HOST, DB_NAME, DB_USER, DB_PASSWORD, DB_TYPE, OBJECT_PATH);

$action = 'default';
if (isset($argv[1])) {
	$action = strtolower($argv[1]);
}

switch ($action) {
	case 'create': {
		if ($argc < 2) {
			echo("Enter the name of at least one script to create.".PHP_EOL.PHP_EOL);
			exit(1);
		} else {
			$scripts = array_slice($argv, 2);
			$scripts_count = count($scripts);

			$x = 1;
			for ($i=0; $i<$scripts_count; ++$i) {
				$script_name = $dbmigrator->create($scripts[$i]);
				echo("Successfully created ".$script_name.PHP_EOL);
				
				if ($x !== $scripts_count) {
					sleep(1);
				}
				$x++;
			}
			echo(PHP_EOL);
		}
		break;
	}

	case 'snapshot': {
		if ($argc != 3) {
			$snapshots_on_disk = $dbmigrator->get_snapshots_on_disk();
			echo("Current snapshots:".PHP_EOL);
			
			foreach ($snapshots_on_disk as $snap) {
				$mig_count = count($snap['migrations']);
				echo($snap['snapshot'].' ('.$mig_count.' migrations)'.PHP_EOL);
			}
		} else {
			$snapshot = $argv[2];
			$dbmigrator->snapshot($snapshot);
		}

		break;
	}

	case 'update': {
		$utc_timestamp = -1;
		if (3 == $argc) {
			$utc_timestamp = trim($argv[2]);
		}

		$dbmigrator->update($utc_timestamp);
		break;
	}

	case 'rollback': {
		$utc_timestamp = 0;
		if (3 == $argc) {
			$utc_timestamp = trim($argv[2]);
		}

		$dbmigrator->rollback($utc_timestamp);
		break;
	}

	case 'default': {
		echo("Usage: dbmigrator [create,snapshot,update,rollback] [<script-name>,<snapshot-name>,[<timestamp>,<snapshot>],[<timestamp>,<snapshot>]]".PHP_EOL.PHP_EOL);
		exit(1);
		break;
	}
}

exit(0);